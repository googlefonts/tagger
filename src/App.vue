<script setup lang="ts">
import type { ComputedRef } from 'vue';
import { onBeforeMount, ref, computed } from 'vue';
import { GF, Font, VariableTagging } from './models';
import type { Tagging } from './models';
import type { Panel } from './components/Panel.vue';
import type { FilterSet } from './components/AddTags.vue';
import { EventBus } from './eventbus';

let appLoaded = ref(false);
let showUndefined = ref(false);
let gf = ref<GF | null>(null);
// @ts-ignore
window.gf = gf; // For debugging 
let panels = ref<Panel[]>([
  { type: 'font', font: 'Roboto' },
  { type: 'categories', categories: ['/Expressive/Loud', '/Expressive/Childlike'], }
]);

let categories: ComputedRef<string[]> = computed(() => {
  return gf.value ? gf.value.uniqueTagNames() : [];
});


function addFontPanel(font: string) {
  panels.value.push({ type: 'font', font });
}
function addTodoPanel() {
  panels.value.push({ type: 'todo' });
}
function addCategoriesPanel(categories: string[]) {
  panels.value.push({
    type: 'categories', categories
  });
}
function removePanel(idx: number) { panels.value.splice(idx, 1); }
function shiftLeft(idx: number) {
  if (idx > 0) {
    const panel = panels.value.splice(idx, 1)[0];
    panels.value.splice(idx - 1, 0, panel);
  }
}
function shiftRight(idx: number) {
  if (idx < panels.value.length - 1) {
    const panel = panels.value.splice(idx, 1)[0];
    panels.value.splice(idx + 1, 0, panel);
  }
}
function removeTag(tag: Tagging) {
  // const index = tags.value!.items.indexOf(tag);
  // if (index !== -1) {
  //   tags.value!.items.splice(index, 1);
  // }
}
function updateTags(newTags: any) {
  // tags.value = newTags;
}

onBeforeMount(async () => {
  gf.value = new GF();
  await gf.value.getFamilyData();
  await gf.value.getLintRules();
  await gf.value.getTagDefinitions();
  gf.value.loadFamilies();
  gf.value.loadTaggings();
  const family = gf.value.families.find(f => f.name === 'Maven Pro');
  if (!family) {
    console.error("Family 'Maven Pro' not found");
  } else {
    family.taggings.push(new VariableTagging(
      family,
      gf.value.tags['/Purpose/Easy Reading'],
      [
        { location: { "wght": 400 }, score: 10 },
        { location: { "wght": 900 }, score: 100 }
      ]
    ));
  }

  // Subscribe to events
  EventBus.$on('ensure-loaded', (family: string) => {
    gf.value?.ensureLoaded(family);
  });

  EventBus.$on('add-font-panel', addFontPanel);
  EventBus.$on('remove-tag', removeTag);
  EventBus.$on('update:tags', updateTags);

  appLoaded.value = true;

});


</script>


<template>
  <div id="app">
    <div id="fonts" :key="gf?.loadedFamilies.length">
      <link v-for="family in gf?.loadedFamilies" :href="family.url" rel="stylesheet">
    </div>
    <div id="content" v-if="appLoaded">
      <button @click="addFontPanel('Maven Pro')">Tags in font</button>
      <button @click="addCategoriesPanel(['/Expressive/Loud'])">Tags in category</button>
      <button @click="addTodoPanel()">Todo List</button>
      <button @click="gf?.exportTaggings()">Save changes</button>
      <input type="checkbox" v-model="showUndefined">Show all</input>
      <div style="display: flex; flex-direction: row; width: 100vw; min-height: 100vh;">
        <div v-for="(panel, idx) in panels" :key="idx"
          :style="{ flex: '1 1 0', minWidth: 0, borderRight: idx < panels.length - 1 ? '1px solid #eee' : 'none', height: '100vh', overflow: 'auto' }">
          <panel :panel="panel" :gf="gf" :idx="idx" @remove-panel="removePanel(idx)" @shift-left="shiftLeft(idx)"
            @shift-right="shiftRight(idx)" :showUndefined="showUndefined">
          </panel>
        </div>
      </div>
    </div>
    <div v-else>Loading...</div>
  </div>
</template>
